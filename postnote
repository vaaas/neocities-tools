#!/usr/bin/env python3

import time
import os
import sys
import subprocess
import lxml.etree as ET

TMP_PATH = os.path.join(os.environ["XDG_RUNTIME_DIR"] or "/tmp", "postnoteeditvar.txt")

def editvar(var=""):
	with open(TMP_PATH, "w") as fil:
		fil.write(var)
	retcode = subprocess.call([os.environ["EDITOR"] or "vim", TMP_PATH])
	if retcode != 0:
		print("Aborted")
		sys.exit(1)
	with open(TMP_PATH, "r") as fil:
		return fil.read()

def E(tag, attrs={}, children=[], text=""):
	elem = ET.Element(tag, attrs)
	for child in children:
		elem.append(child)
	if text:
		elem.text = text
	return elem

def main():
	timestamp = int(time.time())
	tgtfile = os.path.join("posts", "notes", str(timestamp) + ".html")
	body = None
	var = ""
	while body is None:
		var = editvar(var)
		try:
			body = ET.fromstring("<body>%s</body>" % (var,))
		except:
			continue
	tree = E("html",
		children=[
			E("head", children=[
				E("meta", attrs={"name": "timestamp", "value": str(timestamp)}),
				E("meta", attrs={"name": "type", "value": "note"})]),
			body])

	with open(tgtfile, "w") as fil:
		fil.write("<!DOCTYPE html>")
		fil.write(ET.tostring(tree, encoding="unicode"))
		print("Wrote", tgtfile)

if __name__ == "__main__":
	main()
