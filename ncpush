#!/usr/bin/env python3
import sys
import os
import json
import subprocess

def byebye(string):
	print(string)
	sys.exit(1)

def yes_p(string):
	return string.lower() in ["y", "ye", "yes", "yeah", "yup"]

def remote(user, password):
	argv = ["/usr/bin/curl", "https://%s:%s@neocities.org/api/list" % (user, password)]
	j = subprocess.check_output(argv, universal_newlines=True)
	j = json.loads(j)
	if j["result"] != "success":
		byebye("Getting remote files failed")
	return {f["path"]: f["size"] for f in j["files"] if not f["is_directory"]}

def local_files():
	loc = dict()
	for root, dirs, files in os.walk("."):
		for i in files:
			path = os.path.relpath(os.path.join(root, i), ".")
			size = os.stat(path).st_size
			loc[path] = size
	return loc

def diffs(remlist, loclist):
	rset = set(remlist)
	lset = set(loclist)
	remset = rset.difference(lset)
	addset = lset.difference(rset)
	commonset = rset.intersection(lset)
	for i in commonset:
		if remlist[i] != loclist[i]:
			addset.add(i)
	return remset, addset

def remove_remote(what, user, password):
	argv = ["/usr/bin/curl"]
	for i in what:
		argv.append("-d")
		argv.append("filenames[]=" + i)
	argv.append("https://%s:%s@neocities.org/api/delete" % (user, password))
	subprocess.call(argv, stdout=sys.stdout, stderr=sys.stderr)

def upload(what, user, password):
	argv = ["/usr/bin/curl"]
	for i in what:
		argv.append("-F")
		argv.append("%s=@%s" % (i, i))
	argv.append("https://%s:%s@neocities.org/api/upload" % (user, password))
	subprocess.call(argv, stdout=sys.stdout, stderr=sys.stderr)

def main():
	if len(sys.argv) >= 2:
		os.chdir(sys.argv[1])
	elif os.path.isdir("render"):
		os.chdir("render")
	user = input("Username: ")
	password = input("Password: ")
	remove, add = diffs(remote(user, password), local_files())
	if remove:
		print("Deleting", ", ".join(remove))
		if yes_p(input("Proceed? [y/n] > ")):
			remove_remote(remove, user, password)
			print("Done")
	else: print("Nothing to delete")
	if add:
		print("Uploading", ", ".join(add))
		if yes_p(input("Proceed? [y/n] > ")):
			upload(add, user, password)
			print("Done")
	else:
		print("Nothing to upload")

if __name__ == "__main__":
	sys.exit(main())
