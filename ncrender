#!/usr/bin/env python3
import sys, os, time, json, string

CONF = json.loads(open('config').read())
ITEMS = CONF['items']
DIGITS = string.digits + string.ascii_letters
FORCE = False

def main(pathname, args):
	global FORCE
	FORCE = args and args[0] == '-f'
	posts = P(pathname, read, item_stream, map(parse))
	total = P(posts, group(ITEMS))
	P(
		total,
		reversed,
		enumerate,
		mapFirst(niceName('index%s.html')),
		DoubleLink.fromList,
		filter(PP(value, younger)),
		map(render_index),
		map(serialise),
		map(write))
	P(
		total,
		last,
		withFirst('rss.xml'),
		IF(younger,
			PP(render_rss, serialise, write)))

def withFirst(p):
	def inner(x): return (p, x)
	return inner

def IF(cond, then):
	def inner(x):
		if cond(x): return then(x)
	return inner

def P(x, *fs):
	for f in fs: x = f(x)
	return x

def PP(*fs):
	def inner(x): return P(x, *fs)
	return inner

def pluck(k):
	def inner(xs):
		return xs[k]
	return inner

first = pluck(0)
second = pluck(1)
last = pluck(-1)

def prefix(p):
	def inner(x):
		return p + x
	return inner

def map(f):
	def inner(xs):
		for x in xs: yield f(x)
	return inner

def filter(f):
	def inner(xs):
		for x in xs:
			if f(x): yield x
	return inner

def each(f):
	def inner(xs):
		for x in xs: f(x)
	return tap(inner)

def tap(f):
	def inner(x):
		f(x)
		return x
	return inner

def group(n, margin=None):
	if margin is None: margin = n//5
	def inner(xs):
		g = []
		while len(xs) > 0:
			if len(xs) < n + margin:
				g.append(xs[:])
				xs = []
			else:
				g.append(xs[:n])
				xs = xs[:n]
		return g
	return inner

def write(x):
	if not last(x): return
	with open('render/'+first(x), 'w') as p:
		print('Making \033[1m\033[92m%s\033[0m' % (first(x),))
		p.write(last(x))

def niceName(s):
	def inner(x): return s % ('' if x == 0 else (x+1)*ITEMS,)
	return inner

def render_index(items):
	posts = last(items.x)
	prev = first(items.prev.x) if items.prev else None
	next = first(items.next.x) if items.next else None
	return ('html', (('lang', 'en-gb')), (
		('head', None, (
			('meta', (('charset', 'utf-8')), None),
			('meta', (('viewport', 'width=device-width, initial-scale=1.0')), None),
			('meta', (('url', 'https://%s.neocities.org' % (CONF['sitename'],))), None),
			('meta', (('author', CONF['author'])), None),
			('meta', (('description', CONF['title'])), None),
			('link', (('rel', 'stylesheet'), ('href', '/style.css')), None),
			('link', (('rel', 'icon'), ('href', '/favicon.ico?v=2')), None),
			('link', (('rel', 'alternate'), ('href', '/rss.xml'), ('type', 'application/rss+xml')), None),
			('title', None, (CONF['title'],)),
		)),
		('body', None, (
			('a', (('href', '/')),
				(('img', (
					('alt', 'website banner'),
					('class', 'icon'),
					('src', '/pics/ruri_thinking_icon.jpg')),
					None))),
			('header', None, (
				('h1', None, (
					CONF['title'],
					('a', (('href', '/rss.xml')),
						(('img', (
							('alt', 'emoji'),
							('src', '/pics/feed-icon.svg')),
							None))))),
				('nav', None, P(
					CONF['links'],
					map(lambda x: ('a', (('href', CONF['links'][x])), (x,))))),
			)),
			('section', (('id', 'about')), (CONF['about'],)),
			navhead(prev, next),
			('main', None, P(posts, reversed, map(render_index))),
		)),
	))

def render_item(item):
	return ('article', (('id', item.timestamp)), (
		('span', (('class', 'data')), (ymd(item.timestamp),)),
		item.content,
	))

def render_rss(x):
	return ('rss', (
		('version', '2.0'),
		('xmlns:atom', 'http://www.w3.org/2005/Atom')), (
			('channel', None, (
				('title', None, (CONF['title'],)),
				('links', None, ('https://%s.neocities.org' % (CONF['sitename'],),)),
				('atom:link', (
					('href', 'https://%s.neocities.org/rss.xml' % (CONF['sitename'],)),
					('rel', 'self'),
					('type', 'application/rss+xml')),
					None),
				('description', None, (CONF['title'],)),
				('pubDate', None, (rfctime(last(last(x)).timestamp)),),
				('language', None, ('en-gb',)),
				('ttl', None, ('1440',)),
				*P(x, last, reversed, map(render_item_rss)),
		))))

def render_item_rss(item):
	g = guid(item.timestamp)
	return ('item', None, (
		('title', None, ('New post on %s (%s)' % (CONF['sitename'], g),)),
		('guid', (('isPermalink', 'false')), ('post/%s' % (g,),)),
		('pubDate', None, (rfctime(item.timestamp),)),
		('description', None, (escape(absolute_links(item.content)),)),
		('link', None, ('https://%s.neocities.org/#%s' % (CONF['sitename'], g),)),
	))

def navhead(p=None, n=None, up=False):
	children = []
	if p: children.append(('a', (('href', p)), ('← Previous',)))
	if up: children.append(('a', (('href', '../')),  ('↑ Up',)))
	if n: children.append(('a', (('href', n)), ('Next →',)))
	return ('nav', None, children)

def escape(x):
	for i in (('&', '&amp;'), ('<', '&lt;'), ('>', '&gt;')):
		x = x.replace(*i)
	return x

def int_to_base(x, base):
	if x == 0: return DIGITS[0]
	xs = []
	while x:
		x, mod = divmod(x, base)
		xs.append(DIGITS[mod])
	return emptyjoin(reversed(xs))

def absolute_links(x):
	for i in ('href', 'src'):
		x = x.replace(
			'%s="/' % (i,),
			'%s="https://%s.neocities.org/' % (i, CONF["sitename"]))
	return x

def item_stream(fp):
	return fp.read(-1).strip().split('\n\n')

def younger(x):
	if FORCE: return True
	own = P(x, first, prefix('render/'), lambda x: os.path.getmtime(x) if os.path.isfile(x) else -1)
	others = P(x, last, map(timestamp), max)
	return own < others

class Item():
	def __init__(self, stamp, ptype, content):
		self.timestamp = int(stamp)
		self.ptype = ptype
		self.content = content

def serialise(root):
	if isinstance(root, str): return root
	parts = ['<', first(root)]
	if not second(root) is None:
		parts.extend(map(lambda x: '%s="%s"' % (first(x), second(x)))(second(root)))
	if (not last(root) is None) and len(last(root)) > 0:
		parts.append('>')
		parts.extend(map(serialise)(last(root)))
		parts.extend(('</', first(root), '>'))
	else:
		parts.append('/>')
	return emptyjoin(parts)

def parse(x): return Item(*x.strip().split('\n', 2))
def timestamp(x): return x.timestamp
def guid(x): return int_to_base(x, 62)
def ymd(x): return time.strftime('%Y-%m-%d', time.gmtime(x))
def rfctime(x): return time.strftime('%a, %d %b %Y %H:%M:%S +0000', time.gmtime(x))
def emptyjoin(x): return ''.join(x)
def read(x): return open(x, 'r')
def tail(xs): return xs[1:]
def article(x): return x.ptype == 'article'
def mapFirst(f): return map(lambda x: (f(x[0]), x[1]))
def value(x): return x.x

if __name__ == '__main__': main('posts', sys.argv[1:])
