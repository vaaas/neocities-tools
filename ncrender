#!/usr/bin/env python3

import sys
import os
import re
import time
import json
import lxml.etree as ET
from jinja2 import Environment, FileSystemLoader

TPL = Environment(loader=FileSystemLoader("templates"))
CONF = json.load(open("config", "r"))

class Util:
	def now():
		return time.strftime("%a, %d %b %Y %H:%M:%S +0000")

	def full_url(partial):
		return CONF["url"] + Util.url_nohost(partial)

	def url_nohost(partial):
		p = partial.split("/")
		if p[-1] == "index.html": p[-1] = ""
		if p[0] != "": p.insert(0, "")
		return "/".join(p)

	def stamp_to_rfc822(timestamp):
		return time.strftime(
			"%a, %d %b %Y %H:%M:%S +0000",
			time.gmtime(timestamp))

	def stamp_to_ymd(timestamp):
		return time.strftime(
			"%Y-%m-%d",
			time.gmtime(timestamp))
	
	def gen_title(item):
		return "%s %s" % (item.type, str(item.ctime))
	
	def gen_uri(item):
		return Util.full_url("%s/%s" % (item.type, str(item.ctime)))
	
def ranges(count, lim=CONF["items"]):
	div, mod = divmod(count, lim)
	lst = []
	for i in range(div):
		lst.append([i*lim, (i+1)*lim])
	if mod < 10:
		lst[-1][-1] += mod
	else:
		lst.append([div*lim, div*lim + mod])
	return lst

def write(path, what):
	with open(path, "w") as fil:
		fil.write(compactify(what))

def compactify(string):
	string = re.sub(r"\s+", " ", string, flags=re.MULTILINE)
	return string

def tostring(tree):
	return ET.tostring(tree, encoding="unicode", method="xml")

def econtents(elem):
	string = tostring(elem)
	length = len("<%s>" % (elem.tag,))
	start = string.find("<%s>" % (elem.tag,))
	end = string.rfind("</%s>" % (elem.tag,))
	return string[start+length:end]

def inner_text(elem):
	def it_help (elem):
		return (elem.text or "") + "".join([it_help(i) for i in elem]) + (elem.tail or "")
	return (elem.text or "") + "".join([it_help(i) for i in elem])

def html_escape(string):
	return (string.replace("&", "&amp;")
		.replace("<", "&lt;")
		.replace(">", "&gt;"))

class Target:
	def __init__(self, pathname, reqs, callback):
		self.pathname = pathname
		self.reqs = reqs
		self.callback = callback

	def make(self):
		print("‘\033[1m\033[92m" + self.pathname + "\033[0m’" + ":", " ".join([a.pathname for a in self.reqs]))
		self.callback(self.pathname, self.reqs)

	def makep(self):
		own = os.path.getmtime(self.pathname) if os.path.isfile(self.pathname) else -1
		others = [a.mtime for a in self.reqs]
		others.sort()
		return own < others[-1]

class XMLFile:
	def __init__ (self, pathname):
		self.pathname = pathname
		stat = os.stat(self.pathname)
		self.mtime = stat.st_mtime
		self.size = stat.st_size
		self.tree = ET.parse(self.pathname)
		self.ctime = int(
			self.tree.find("./head/meta[@name='timestamp']").attrib["value"])
		tmp = self.tree.find("./body/h1")
		self.title = None if tmp is None else html_escape(inner_text(tmp))
		self.blurb = tostring(self.tree.find("./body//p[1]"))

class Article(XMLFile):
	type = "Article"
	def __init__(self, pathname):
		super(Article, self).__init__(pathname)
		self.href = Util.url_nohost("/".join(self.pathname.split("/")[1:]))
		self.body = econtents(self.tree.find("./body"))
		del self.tree

class Note(XMLFile):
	type = "Note"
	def __init__(self, pathname):
		super(Note, self).__init__(pathname)
		self.href = "/"
		del self.tree

class Link(XMLFile):
	type = "Link"
	def __init__(self, pathname):
		super(Link, self).__init__(pathname)
		self.href = html_escape(self.tree.find("./body/h1/a[1]").attrib["href"])
		del self.tree

class Picture(XMLFile):
	type = "Picture"
	def __init__(self, pathname):
		super(Picture, self).__init__(pathname)
		self.href = html_escape(self.tree.find("./body/p/a[1]").attrib["href"])
		del self.tree

class Video(XMLFile):
	type = "Video"
	def __init__(self, pathname):
		super(Video, self).__init__(pathname)
		self.href = html_escape(self.tree.find("./body/h1/a[1]").attrib["href"])
		del self.tree

def selector(string):
	return {
		"articles": Article,
		"notes": Note,
		"pictures": Picture,
		"videos": Video,
		"links": Link}[string]

def item(xmlfile):
	template = TPL.get_template("item.html")
	return template.render(conf=CONF, item=xmlfile, util=Util, title=xmlfile.title, date=Util.stamp_to_rfc822(xmlfile.ctime))

def index(articles, href_prev=None, href_next=None):
	articles.reverse()
	template = TPL.get_template("index.html")
	return template.render(conf=CONF, items=articles, util=Util, title=CONF["site"], date=Util.now(), href_prev=href_prev, href_next=href_next)

def rss(articles):
	articles.reverse()
	template = TPL.get_template("rss.xml")
	return template.render(conf=CONF, items=articles, util=Util)

def main(args):
	force = len(args) > 0 and args[0] == "-f"

	source = "posts"
	target = "render"

	xmlfiles = []
	for tp in os.listdir(source):
		xmlfiles += [selector(tp)(os.path.join(source, tp, i)) for i in os.listdir(os.path.join(source,tp))]
	xmlfiles.sort(key=lambda x: x.ctime)

	tgts = []
	for xmlfile in [xmlfile for xmlfile in xmlfiles if xmlfile.type == "Article"]:
		parts = xmlfile.pathname.split(os.sep)
		parts[0] = target
		for i in range(len(parts)-1):
			pathname = os.path.join(*parts[:i+1])
			if not os.path.isdir(pathname):
				os.mkdir(pathname)
		tgts.append(Target(os.path.join(*parts), [xmlfile],
			lambda me, reqs: write(me, item(reqs[0]))))

	tgts.append(Target(
		os.path.join(target, "rss.xml"),
		xmlfiles[-CONF["items"]:],
		lambda me, reqs: write(me, rss(reqs))))

	args = [{"name": "index%s.html" % (str(start),), "xmlfiles": xmlfiles[start:end]} for start, end in ranges(len(xmlfiles))]
	args[-1]["name"] = "index.html"
	for i in range(len(args)):
		args[i]["href_prev"] = "/" + args[i-1]["name"] if i > 0 else None
		args[i]["href_next"] = "/" + args[i+1]["name"] if i+1 < len(args) else None
	for i in args:
		tgts.append(Target(os.path.join(target, i["name"]), i["xmlfiles"],
			lambda me, reqs, p=i["href_prev"], n=i["href_next"]: write(me, index(reqs, p, n))))

	for tgt in tgts:
		if force or tgt.makep():
			tgt.make()

if __name__ == "__main__":
	main(sys.argv[1:])
