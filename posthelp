#!/usr/bin/env python3

import time
import os
import sys
import json
import subprocess

TMPFILE = os.path.join(os.environ["XDG_RUNTIME_DIR"] or "/tmp", "postnoteeditvar.txt")
RS = chr(30)
ARTICLE = ("\n" + RS + "\n").join(("File name", "Title", "Blurb", "Body"))
APP = ("\n" + RS + "\n").join(("File name", "Title", "Blurb", "Contents"))

def timestamp(): return int(time.time())

def editvar(var=""):
	with open(TMPFILE, "w") as fp:
		fp.write(var)
	retcode = subprocess.call([os.environ["EDITOR"] or "vim", TMPFILE])
	if retcode != 0:
		print("Aborted")
		sys.exit(1)
	with open(TMPFILE, "r") as fp:
		return fp.read()

def write(pathname, what):
	with open(pathname, "w") as fp:
		fp.write(what)
	print("Wrote", pathname)

def note(*args):
	content = editvar()
	obj = { "cdate": timestamp(), "blurb": content }
	pathname = os.path.join(".", "posts", "notes", str(obj["cdate"]) + ".json")
	write(pathname, json.dumps(obj))

def article(*args):
	content = editvar(ARTICLE).split(RS)
	name = content[0].strip()
	title = content[1].strip() 
	blurb = content[2].strip()
	body = content[3].strip()
	pathname = os.path.join(".", "posts", "articles", re.sub(r".html$", ".json", name))
	obj = { "title": title, "blurb": blurb, "body": body, "cdate": timestamp() }
	write(pathname, json.dumps(obj))

def main():
	FNS = {"a": article, "n": note}
	answer = ""
	while True:
		answer = input("Select post type:\n\t(n)ote\n\t(a)rticle\n> ")
		if answer in ("n", "a"): break
	return FNS[answer.strip()](sys.argv[1:])

if __name__ == "__main__":
	sys.exit(main())
